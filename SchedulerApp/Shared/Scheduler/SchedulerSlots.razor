@namespace SchedulerApp.Shared.Scheduler
@using MudBlazor
@using Newtonsoft.Json
@using SchedulerApp.Shared.Scheduler
@using System.Collections.Generic
@using SchedulerApp.Data.Scheduler
@using SchedulerApp.Modules
@using MudBlazorFix

@inject SchedulingAPIService sAPIs
@inject ISnackbar Snackbar

<div>
    <div>
        <MudSwitch Label="Duplicate 1st week entry?" Color="Color.Info" @bind-Checked="UseFirstForNewWeek" />
        <MudSwitch Label="Duplicate 1st day entry?" Color="Color.Info" @bind-Checked="UseFirstForNewDay" />

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            @try
            {
                var weeksCollection = ProblemScope.Problem.Schedule.Weeks.Cast<dynamic>().ToList();
                <SchedulerSlotsColumn SelectedIndex="@SelectedWeek" IndexChanged="OnIndexChanged" CollectionChanged="OnScheduleChanged" tableName="Week" collection="@weeksCollection" InstanceType="typeof(Week)" UseFirstForNew="@UseFirstForNewWeek" />
                
            }
            catch (ArgumentOutOfRangeException)
            {
                <SchedulerSlotsColumn SelectedIndex="@SelectedWeek" IndexChanged="OnIndexChanged" CollectionChanged="OnScheduleChanged" tableName="Week" collection="new List<dynamic>()" InstanceType="typeof(Week)" UseFirstForNew="@UseFirstForNewWeek" />
            }
            @try
            {
                var daysCollection = ProblemScope.Problem.Schedule.Weeks[SelectedWeek].Days.Cast<dynamic>().ToList();
                <SchedulerSlotsColumn SelectedIndex="@SelectedDay" IndexChanged="OnIndexChanged" CollectionChanged="OnScheduleChanged" tableName="Day" collection="@daysCollection" InstanceType="typeof(Day)" UseFirstForNew="@UseFirstForNewDay" />
            }
            catch (ArgumentOutOfRangeException)
            {
                <SchedulerSlotsColumn SelectedIndex="@SelectedDay" IndexChanged="OnIndexChanged" CollectionChanged="OnScheduleChanged" tableName="Day" collection="new List<dynamic>()" InstanceType="typeof(Day)" UseFirstForNew="@UseFirstForNewDay" />
            }
            @try
            {
                var timeSlotsCollection = ProblemScope.Problem.Schedule.Weeks[SelectedWeek].Days[SelectedDay].TimeSlots.Cast<dynamic>().ToList();
                <SchedulerSlotsColumn SelectedIndex="@SelectedTimeSlot" IndexChanged="OnIndexChanged" CollectionChanged="OnScheduleChanged" tableName="Time slot" collection="@timeSlotsCollection" InstanceType="typeof(TimeSlot)" />
            }
            catch (ArgumentOutOfRangeException)
            {
                <SchedulerSlotsColumn SelectedIndex="@SelectedTimeSlot" IndexChanged="OnIndexChanged" CollectionChanged="OnScheduleChanged" tableName="Time slot" collection="new List<dynamic>()" InstanceType="typeof(TimeSlot)" />
            }
            @try
            {
                var shiftsCollection = ProblemScope.Problem.Schedule.Weeks[SelectedWeek].Days[SelectedDay].TimeSlots[SelectedTimeSlot].Shifts.Cast<dynamic>().ToList();
                <SchedulerSlotsColumn SelectedIndex="@SelectedShift" IndexChanged="OnIndexChanged" CollectionChanged="OnScheduleChanged" tableName="Shift" collection="@shiftsCollection" InstanceType="typeof(ShiftInfo)" />
            }
            catch (ArgumentOutOfRangeException)
            {
                <SchedulerSlotsColumn SelectedIndex="@SelectedShift" IndexChanged="OnIndexChanged" CollectionChanged="OnScheduleChanged" tableName="Shift" collection="new List<dynamic>()" InstanceType="typeof(ShiftInfo)" />
            }

        </div>
    </div>
</div>

@code {
    public bool UseFirstForNewDay = false;
    public bool UseFirstForNewWeek = false;

    private async Task OnScheduleChanged((List<dynamic> collection, string tableName) caller) 
    {
        if (CheckExistingSlotsWrong(caller.tableName))
        {
            await CascadeMissing(caller.tableName);
            return;
        }
        

        switch (caller.tableName){
            default:
                throw new NotImplementedException("No implemented collection handler");
            case "Week":
                ProblemScope.Problem.Schedule.Weeks = caller.collection.Cast<Week>().ToList();
                break;
            case "Day":
                ProblemScope.Problem.Schedule.Weeks[SelectedWeek].Days = caller.collection.Cast<Day>().ToList();
                break;
            case "Time slot":
                ProblemScope.Problem.Schedule.Weeks[SelectedWeek].Days[SelectedDay].TimeSlots = caller.collection.Cast<TimeSlot>().ToList();
                break;
            case "Shift":
                ProblemScope.Problem.Schedule.Weeks[SelectedWeek].Days[SelectedDay].TimeSlots[SelectedTimeSlot].Shifts = caller.collection.Cast<ShiftInfo>().ToList();
                break;
        }
        await ProblemScopeChanged.InvokeAsync(ProblemScope);
    }

    private async Task OnIndexChanged((int, string) indexCall)
    {
        switch (indexCall.Item2)
        {
            default:
                throw new NotImplementedException("No implemented handler");
            case "Week":
                SelectedWeek = indexCall.Item1;
                ProblemScope.SelectedWeek = SelectedWeek;
                break;
            case "Day":
                SelectedDay = indexCall.Item1;
                ProblemScope.SelectedDay = SelectedDay;
                break;
            case "Time slot":
                SelectedTimeSlot = indexCall.Item1;
                ProblemScope.SelectedTimeSlot = SelectedTimeSlot;
                break;
            case "Shift":
                SelectedShift = indexCall.Item1;
                ProblemScope.SelectedShift = SelectedShift;
                break;
        }
        await ProblemScopeChanged.InvokeAsync(ProblemScope);
    }



    private bool CheckExistingSlotsWrong(string tableName)
    {
        // check if the needed slots exist before trying to add one

        if (tableName != "Week")
        {
            if (SelectedWeek >= ProblemScope.Problem.Schedule.Weeks.Count) { Snackbar.Add("Add a week first", Severity.Info); return true; }
            if (tableName != "Day")
            {
                if (SelectedDay >= ProblemScope.Problem.Schedule.Weeks[SelectedWeek].Days.Count) { Snackbar.Add("Add a day first", Severity.Info); return true; }
                if (tableName != "Time slot")
                {
                    if (SelectedTimeSlot >= ProblemScope.Problem.Schedule.Weeks[SelectedWeek].Days[SelectedDay].TimeSlots.Count) { Snackbar.Add("Add a time slot first", Severity.Info); return true; }
                }
            }
        }
        return false;
    }

    private async Task CascadeMissing(string tableName)
    {
        if (tableName == "Day" && ProblemScope.Problem.Schedule.Weeks.Count == 0)
        {
            ProblemScope.Problem.Schedule.Weeks.Add(new Week());
        } else if (tableName == "Time slot")
        {
            if (ProblemScope.Problem.Schedule.Weeks.Count == 0)
            {
                ProblemScope.Problem.Schedule.Weeks.Add(new Week());
            }
            if(ProblemScope.Problem.Schedule.Weeks[SelectedWeek].Days.Count == 0)
            {
                ProblemScope.Problem.Schedule.Weeks[SelectedWeek].Days.Add(new Day());
            }
        } else if (tableName == "Shift")
        {
            if (ProblemScope.Problem.Schedule.Weeks.Count == 0)
            {
                ProblemScope.Problem.Schedule.Weeks.Add(new Week());
            }
            if (ProblemScope.Problem.Schedule.Weeks[SelectedWeek].Days.Count == 0)
            {
                ProblemScope.Problem.Schedule.Weeks[SelectedWeek].Days.Add(new Day());
            }
            if (ProblemScope.Problem.Schedule.Weeks[SelectedWeek].Days[SelectedDay].TimeSlots.Count == 0)
            {
                ProblemScope.Problem.Schedule.Weeks[SelectedWeek].Days[SelectedDay].TimeSlots[SelectedTimeSlot].Shifts.Add(new ShiftInfo());
            }
        } 
        else
        {
            return;
        }
        await ProblemScopeChanged.InvokeAsync(ProblemScope);
        return;
    }

    public delegate bool CheckExistingDelegate(string tableName);




    private int SelectedWeek = 0;
    private int SelectedDay = 0;
    private int SelectedTimeSlot = 0;
    private int SelectedShift = 0;


    [Parameter]
    public EventCallback<ProblemScope> ProblemScopeChanged { get; set; }

    [Parameter]
    public ProblemScope ProblemScope { get; set; } = default!;

    override protected void OnInitialized()
    {
        SelectedWeek = ProblemScope.SelectedWeek;
        SelectedDay = ProblemScope.SelectedDay;
        SelectedTimeSlot = ProblemScope.SelectedTimeSlot;
        SelectedShift = ProblemScope.SelectedShift;
    }
}
